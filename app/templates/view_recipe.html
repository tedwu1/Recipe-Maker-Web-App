{% extends "base.html" %}
{% block title %}View Recipe{% endblock %}

{% block content %}
  <h2>{{ recipe.title }}</h2>
  <p><strong>Description:</strong> {{ recipe.description }}</p>

  <p><strong>Ingredients:</strong></p>
  <!-- give this pre an id so we can grab it in JS -->
  <pre id="ingredients">{{ recipe.ingredients }}</pre>
  <button type="button" onclick="copyIngredients()">Copy Ingredients</button>

  <p><strong>Instructions:</strong></p>
  <pre>{{ recipe.instructions }}</pre>
  <p><em>By {{ recipe.author.username }}</em></p>

  <hr>
  <h3>Share this recipe</h3>
  <div>
    <input type="text" id="share-link" value="{{ request.url }}" readonly style="width:80%">
    <button type="button" onclick="copyLink()">Copy Link</button>
  </div>

  <hr>
  <h3>Comments</h3>
  {% if comments %}
    <ul>
      {% for comment in comments %}
        <li>
          <strong>{{ comment.author.username }}</strong>
          <em>({{ comment.timestamp.strftime('%Y-%m-%d %H:%M') }})</em>:<br>
          {{ comment.body }}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No comments yet.</p>
  {% endif %}

  {% if user %}
    <form method="POST">
      <label for="comment">Add a comment:</label><br>
      <textarea id="comment" name="comment" rows="4" required></textarea><br>
      <button type="submit">Submit Comment</button>
    </form>
  {% else %}
    <p><a href="{{ url_for('login') }}">Log in</a> to leave a comment.</p>
  {% endif %}

  <p><a href="{{ url_for('recipes') }}">&larr; Back to all recipes</a></p>

  <script>
    function copyLink() {
      const input = document.getElementById('share-link');
      input.select();
      document.execCommand('copy');
      alert('Recipe URL copied to clipboard!');
    }

    function copyIngredients() {
      const text = document.getElementById('ingredients').innerText;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert('Ingredients copied to clipboard!'))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Ingredients copied to clipboard!');
    }
  </script>
{% endblock %}
